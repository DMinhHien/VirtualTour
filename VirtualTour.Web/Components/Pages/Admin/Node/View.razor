@page "/admin/view"
@layout AdminLayout
@using MudBlazor
@using Newtonsoft.Json
@using VirtualTour.Web.Components.BaseComponents
@using VirtualTour.Web.Components.Layout
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IApiClient ApiClient
<style>

    #viewer-container {
        position: relative;
        width: 100vw;
        height: 100vh;
    }

    #sidebar-overlay {
        position: absolute;
        left: 0;
        top: 0;
        width: 100px;
        height: 300px;
        z-index: 10;
    }
</style>
 <div id="viewer-container">
<div id="viewer" style="width:80vw; height:70vh;"></div>
    <div id="sidebar-overlay" style=" align-items: center; width: 250px;">
        @if (IsLoadingNodes)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        }
        else if (Nodes is null || Nodes.Count == 0)
        {
            <MudPaper Elevation="1" Style="padding:16px; background-color:#1e1e1e; color:#cfcfcf;">
                <MudText Typo="Typo.subtitle2">No nodes have been added.</MudText>
                <MudText Typo="Typo.caption">Create a node to begin the virtual tour.</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                           OnClick="@(() => Navigation.NavigateTo("/admin/node/create"))">
                    Add Node
                </MudButton>
            </MudPaper>
        }
        else
        {
            <MudDrawer @bind-Open="@_open" style="width:200px;height:fit-content" Elevation="0" Variant="@DrawerVariant.Persistent">
                <MudPaper Width="200px" Class=" sidebar-full-height" Elevation="0"
                          Style="background-color: #0b0b0b;border-radius: 0;">
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowBackIos"
                                   Variant="Variant.Filled"
                                   Style="background-color:white;border-radius:unset;margin-left:170px "
                                   Size="Size.Small"
                                   OnClick="@ToggleDrawer" />
                    <MudNavMenu Dense="true">
                        @foreach (var sectionGroup in Nodes
                                            .GroupBy(n => n.SectionId)
                                            .OrderBy(g => GetSectionName(g.Key)))
                        {
                            <MudNavGroup Dense="true"
                                         HideExpandIcon="true"
                                         Expanded="false">
                                <TitleContent>
                                    <MudText Style="color:#bfbfbf;font-weight:600;font-size:13px;">
                                        @GetSectionName(sectionGroup.Key)
                                    </MudText>
                                </TitleContent>
                                <ChildContent>
                                    @foreach (var node in sectionGroup.OrderBy(n => n.Name))
                                    {
                                        <MudNavLink OnClick="@(() => GetElement(node.Id))"
                                                    ActiveClass="custom-active">
                                            <span style="font-size:14px;">@node.Name</span>
                                        </MudNavLink>
                                    }
                                </ChildContent>
                            </MudNavGroup>
                        }
                    </MudNavMenu>
                </MudPaper>
            </MudDrawer>
            <MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos"
                           Variant="Variant.Filled"
                           Style="background-color:white;border-radius:unset"
                           Size="Size.Small"
                           OnClick="@ToggleDrawer" />
        }        
       
    </div>

</div>
@code {
    int startId = 0;
    private bool _open = true;
    public List<NodeModel> Nodes;
    private List<SectionModel> Sections = new();
    private Dictionary<int, string> SectionNames = new();
    NodeModel _nodeModel = new NodeModel();
    private bool IsLoadingNodes = true;
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadSections();
        await LoadNodes();
        if (Nodes is not null && Nodes.Count > 0)
        {
        _nodeModel = Nodes.FirstOrDefault(x => x.IsStartNode);
            var dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initVirtualTourApi", "viewer", _nodeModel, dotNetRef);
        }
    }
    protected async Task LoadNodes()
    {
        var res = await ApiClient.GetFromJsonAsync<BaseResponseModel>("/api/node/getListUse");
        if (res.Success)
        {
            Nodes = JsonConvert.DeserializeObject<List<NodeModel>>(res.Data.ToString());
        }
        IsLoadingNodes = false;
        StateHasChanged();
    }
    private async Task LoadSections()
    {
        // NOTE: Adjust the endpoint if your API differs (e.g., "/api/section/getList")
        var res = await ApiClient.GetFromJsonAsync<BaseResponseModel>("/api/section/getListUse");
        if (res.Success && res.Data != null)
        {
            Sections = JsonConvert.DeserializeObject<List<SectionModel>>(res.Data.ToString());
            SectionNames = Sections?.ToDictionary(s => s.Id, s => s.SectName) ?? new();
        }
    }
    private string GetSectionName(int sectionId)
       => SectionNames.TryGetValue(sectionId, out var name) ? name : $"Section {sectionId}";

    [JSInvokable]
    public async Task GetNextNode(int nextId)
    {
        var response = await ApiClient.GetFromJsonAsync<BaseResponseModel>($"api/node/getElementById/{nextId}");
        if (response.Success && response.Data != null)
        {
            _nodeModel = JsonConvert.DeserializeObject<NodeModel>(response.Data.ToString());
            var dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initVirtualTourApi", "viewer", _nodeModel, dotNetRef);
        }
        else
        {
            // Handle error case, e.g., show a message to the user
            Console.WriteLine("Error fetching next node data.");
        }
    }
    private void ToggleDrawer()
    {
        _open = !_open;
    }
    // private async Task OpenWS2()
    // {
    //     var response = await ApiClient.GetFromJsonAsync<BaseResponseModel>($"api/node/getElementById/{27}");
    //     if (response.Success && response.Data != null)
    //     {
    //         _nodeModel = JsonConvert.DeserializeObject<NodeModel>(response.Data.ToString());
    //     }
    //     var dotNetRef = DotNetObjectReference.Create(this);
    //     await JS.InvokeVoidAsync("initVirtualTourApi", "viewer", _nodeModel, dotNetRef);

    // }
    private async Task GetElement(int id)
    {
        var response = await ApiClient.GetFromJsonAsync<BaseResponseModel>($"api/node/getElementById/{id}");
        if (response.Success && response.Data != null)
        {
            _nodeModel = JsonConvert.DeserializeObject<NodeModel>(response.Data.ToString());
            var dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("initVirtualTourApi", "viewer", _nodeModel, dotNetRef);
        }
        else
        {
            Console.WriteLine("Error fetching node data.");
        }
    }
}

@page "/admin/user"
@using System.Globalization
@using BlazorBootstrap
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@layout AdminLayout
@using VirtualTour.Web.Components.BaseComponents
@using VirtualTour.Web.Components.Layout
@inject NavigationManager Navigation
 <PermissionView Permission="Admin.View">
@if (Users == null)
{
    <p>Loading ...</p>
}
else
{
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h3" Class="fw-bold">User List</MudText>
               <PermissionView Permission="Users.Create">
    <MudButton Color="Color.Primary"
                       Variant="Variant.Filled" Size="Size.Small"
               OnClick="@(() => Navigation.NavigateTo($"/admin/user/create?newId={NewUserId}"))">
        <MudIcon Icon="@Icons.Material.Filled.Add" /> Create New User
    </MudButton>
            </PermissionView>
        </MudStack>
    <MudContainer Class="mt-4 w-100" Style="width: 100%; max-width: none;">


        <MudDataGrid T="UserModel"
                     Items="@(Users?.Where(u => u.InActive !=1).ToList())"
                     @ref="UserGrid"
                     Filterable="true"
                     Sortable="true"
                     PageSize="5"
                     FilterMode="@DataGridFilterMode.ColumnFilterRow">
            <Columns>
                <PropertyColumn Filterable="false" Property="x => x.Id" Title="ID" />
                <PropertyColumn Property="x => x.UserName" Title="User Name" />
                <PropertyColumn Property="x => x.Email" Title="Email" />
                <PropertyColumn Property="x => x.HashKey" Filterable="false" Title="Api Key" >
                    <CellTemplate>
                            @if (context.Item.ExpiredAt < DateTime.Now)
                            {
                                <span style="color:red">@context.Item.HashKey</span>
                            }
                            else
                            {
                                @context.Item.HashKey
                            }
                        <MudIconButton Icon="@Icons.Material.Filled.RestartAlt"
                                       Size="Size.Small"
                                       Color="Color.Info"
                                       onclick="@(()=>{RefreshID=context.Item.Id;RefreshApiKey();})" />
                    </CellTemplate>
                </PropertyColumn>
                <PropertyColumn Property="x => x.RoleName" Title="Role" />
                <PermissionView Permission="Users.Edit">
                    <TemplateColumn Filterable="false" Sortable="false">
                        <CellTemplate>   
                              <MudStack Row="true" Spacing="2">
                                <PermissionView Permission="Users.Edit">
                                        <MudTooltip Text="Edit">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                           Size="Size.Small"
                                                           Color="Color.Primary"
                                                           OnClick='@(() => Navigation.NavigateTo($"/admin/user/update/{context.Item.Id}"))' />
                                        </MudTooltip>
                                </PermissionView>
                                <PermissionView Permission="Users.Delete">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       Size="Size.Small"
                                                       Color="Color.Error"
                                                       OnClick="@(() => { DeleteID=context.Item.Id; OnShowModalClick(); })" />
                                </PermissionView>
                            </MudStack>
                        </CellTemplate>
                    </TemplateColumn>
                </PermissionView>
            </Columns>
            <PagerContent>
                <MudDataGridPager T="UserModel" />
            </PagerContent>
        </MudDataGrid>

        <Modal @ref="Modal" title="Notification">
            <BodyTemplate>
                Are you sure you want to delete this user?
            </BodyTemplate>
            <FooterTemplate>
                <Button Color="ButtonColor.Primary" style="width:80px" @onclick="HandleDelete">Yes</Button>
                <Button Color="ButtonColor.Secondary" @onclick="OnHideModalClick">Cancel</Button>
            </FooterTemplate>
        </Modal>

            <Modal @ref="RefreshModal" title="Notification">
                <BodyTemplate>
                    You are refreshing your own API key. This will log you out and you will need to log in again with the new key. Do you want to proceed?
                </BodyTemplate>
                <FooterTemplate>
                    <Button Color="ButtonColor.Primary" style="width:80px" @onclick=" RefreshOwnApiKey">Yes</Button>
                    <Button Color="ButtonColor.Secondary" @onclick="OnHideRefreshModalClick">Cancel</Button>
                </FooterTemplate>
            </Modal>
    </MudContainer>
}
</PermissionView>
@code {

}

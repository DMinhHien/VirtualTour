@page "/admin/areas"
@using System.Globalization
@layout AdminLayout
@using BlazorBootstrap
@using VirtualTour.Model
@using VirtualTour.Web.Components.BaseComponents
@using MudBlazor
@using VirtualTour.Web.Components.Layout
<PermissionView Permission="Admin.View">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h3" Class="fw-bold">Area List</MudText>
            <MudButton  Variant="Variant.Filled" Size="Size.Small" Color="Color.Primary" @onclick="ToggleCreateCard">
                <MudIcon Icon="@Icons.Material.Filled.Add" /> Create New Area
                </MudButton>
    </MudStack>
</PermissionView>
@if (Areas == null)
{
    <p>Loading Areas...</p>
}
else
{
        <MudStack  AlignItems="AlignItems.Center" Row="true">
    <div>
        <label>Section:</label>
        <InputSelect style="height:35px;width:220px" @bind-Value="SelectedSectionId">
            <option Value="None">None</option>
            @if (Sections != null)
            {
                foreach (var area in Sections)
                {
                    <option Value="@area.Id">@area.SectName</option>
                }
            }
        </InputSelect>
    </div>
    <div>
        <label>Floor:</label>
        <InputSelect style="height:35px;width:220px" @bind-Value="SelectedFloorId">
            <option Value="None">None</option>
            @if (Floors != null)
            {
        foreach (var area in Floors.Where(x => x.SectId == SelectedSectionId))
                {
                    <option Value="@area.Id">@area.FloorNum</option>
                }
            }
        </InputSelect>
    </div>
    </MudStack>
     <MudContainer Class="mt-4 w-75" Style="width: 100%; max-width: none;">
    <MudDataGrid T="AreaModel"
                 Items="@Areas?.Where(x=>x.SectId==SelectedSectionId
                                        &&x.FloorId==SelectedFloorId).ToList()"
                 @ref="AreaGrid"
                 Filterable="true"
                 Sortable="true"
                 PageSize="5"
                 Dense="true"
                 FilterMode="@DataGridFilterMode.ColumnFilterRow">
        <Columns>
                <PropertyColumn Filterable="false" Property="x => x.Id" Title="ID" />
            <PropertyColumn Property="x => x.AreaName" Title="Area Name" />
                    <PropertyColumn Filterable="false" Property="x => x.CreatedAt" Title="Created Date">
                   <CellTemplate>
                            @context.Item.CreatedAt.ToString("dd/MM/yyyy", CultureInfo.InvariantCulture)
                   </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.IsActive" Title="Active">
                  <CellTemplate>
                    @if (context.Item.IsActive)
                    {
                            <MudChip Color="Color.Primary" Style="width:50px">Yes</MudChip>
                    }
                    else
                    {
                            <MudChip Color="Color.Error" Style="width:50px">No</MudChip>
                    }
            </CellTemplate>
            </PropertyColumn>
            <TemplateColumn  Filterable="false" Sortable="false">
                <CellTemplate>
                     <MudStack Row="true" Spacing="2">
                                <PermissionView Permission="Roles.Edit">
                                  <MudTooltip Text="Edit">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                                   Color="Color.Primary"
                                               @onclick="() => EditArea(context.Item)">
                                </MudIconButton>
                            </MudTooltip>
                        </PermissionView>
                            <PermissionView Permission="Roles.Delete">
                                <MudTooltip Text="Delete">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="@(() => { DeleteId = context.Item.Id; OnShowModalDeleteClick(); })" />
                                </MudTooltip>
                            </PermissionView>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
    </MudContainer>
 }
<Modal @ref="ModalDelete" title="Notification">
    <BodyTemplate>
        Are you sure you want to delete this role?
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Primary" style="width:80px" @onclick="HandleDelete">Yes</Button>
        <Button Color="ButtonColor.Secondary" @onclick="OnHideModalDeleteClick">Cancel</Button>
    </FooterTemplate>
</Modal>
<Modal @ref="ModalCreate" title="Create New Area" IsVerticallyCentered="true" IsScrollable="true">
    <BodyTemplate>
        <div class="card-body">
            <div class="form-group mb-3">
                <MudTextField Style="background-color: white;"
                              Required="true" Label="Area Name"
                              @bind-Value="newArea.AreaName" Variant="Variant.Outlined" />
            </div>
            <div class="form-group mb-3">
                <label>Active</label>
                <input type="checkbox" class="form-check-input" @bind="newArea.IsActive" />
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Primary" style="width:180px" @onclick="CreateArea">Create Floor</Button>
        <Button Color="ButtonColor.Secondary" @onclick="OnHideModalCreateClick">Cancel</Button>
    </FooterTemplate>
</Modal>

<Modal @ref="ModalEdit" title="Update Area" IsVerticallyCentered="true" IsScrollable="true">
    <BodyTemplate>
        <div class="card-body">
            <div class="form-group mb-3">
                <MudTextField Style="background-color: white;"
                              Required="true" Label="Area Name"
                              @bind-Value="editingArea.AreaName" Variant="Variant.Outlined" />
            </div>
            <div class="form-group mb-3">
                <label>Active</label>
                <input type="checkbox" class="form-check-input" @bind="editingArea.IsActive" />
            </div>
        </div>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Primary" style="width:180px" @onclick="() => UpdateArea(editingArea)">Update Area</Button>
        <Button Color="ButtonColor.Secondary" @onclick="OnHideModalEditClick">Cancel</Button>
    </FooterTemplate>
</Modal>

@code {
    private async Task<GridDataProviderResult<AreaModel>> RolesDataProvider(GridDataProviderRequest<AreaModel> request)
    {
        return await Task.FromResult(request.ApplyTo(Areas));
    }
}
